# library baseline (CountVectorizer + MultinomialNB)
#  Same 5 folds


from sklearn.feature_extraction.text import CountVectorizer
from sklearn.naive_bayes import MultinomialNB

def tokens_to_text(token_lists):
    """
    Convert tokens back to text so CountVectorizer can read it.
    Example: ['profit','rose'] -> "profit rose"
    """
    return [" ".join(tokens) for tokens in token_lists]


def run_5fold_cv_library(train_df, k=5, seed=42):
    n = len(train_df)
    folds = make_k_folds(n, k=k, seed=seed)

    fold_accuracies = []

    for fold_id in range(k):
        valid_idx = set(folds[fold_id])
        train_idx = [i for i in range(n) if i not in valid_idx]

        fold_train = train_df.iloc[train_idx]
        fold_valid = train_df.iloc[list(valid_idx)]

        # Convert tokens to strings (library expects text)
        X_train_text = tokens_to_text(fold_train["tokens"].tolist())
        X_valid_text = tokens_to_text(fold_valid["tokens"].tolist())

        y_train = fold_train["binary_label"].tolist()
        y_valid = fold_valid["binary_label"].tolist()

        # Bag of Words (library)
        vectorizer = CountVectorizer()
        X_train_vec = vectorizer.fit_transform(X_train_text)
        X_valid_vec = vectorizer.transform(X_valid_text)

        # Naive Bayes (library)
        model = MultinomialNB(alpha=1.0)  # Laplace smoothing
        model.fit(X_train_vec, y_train)

        # Predict and evaluate
        y_pred = model.predict(X_valid_vec)
        acc = compute_accuracy(y_valid, y_pred)

        fold_accuracies.append(acc)
        print(f"[Library] Fold {fold_id+1}/{k} accuracy: {acc:.4f}")

    mean_acc = sum(fold_accuracies) / len(fold_accuracies)
    variance = sum((a - mean_acc) ** 2 for a in fold_accuracies) / len(fold_accuracies)
    std_acc = math.sqrt(variance)

    return fold_accuracies, mean_acc, std_acc


# RUN  (same k and seed as scratch for fair comparison)
lib_fold_accs, lib_mean_acc, lib_std_acc = run_5fold_cv_library(train_f, k=5, seed=42)

print("\n[Library] Fold accuracies:", [round(a, 4) for a in lib_fold_accs])
print("[Library] Mean accuracy:", round(lib_mean_acc, 4))
print("[Library] Std (variation):", round(lib_std_acc, 4))
